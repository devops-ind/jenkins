#!/bin/bash
set -e

BACKUP_DIR="{{ backup_dir }}/$(date +%Y-%m-%d-%H-%M-%S)"
mkdir -p "${BACKUP_DIR}"

docker run --rm \
  -v {{ jenkins_data_volume }}:/jenkins_home \
  -v "${BACKUP_DIR}":/backup \
  ubuntu \
  tar -czf /backup/jenkins_home.tar.gz -C /jenkins_home .

docker run --rm \
  -v {{ shared_workspace_volume }}:/jenkins_workspace \
  -v "${BACKUP_DIR}":/backup \
  ubuntu \
  tar -czf /backup/jenkins_workspace.tar.gz -C /jenkins_workspace .

# Prune old backups, keep last 7
find "{{ backup_dir }}" -mindepth 1 -maxdepth 1 -type d -daystart -mtime +7 -exec rm -rf {} \;
